((h,f)=>{XF.EditorManager=XF.Element.newHandler({options:{dragListClass:".js-dragList",commandTrayClass:".js-dragList-commandTray"},lists:null,trayElements:[],listElements:[],isScrollable:!0,dragula:null,cache:null,xfEditor:null,init(){this.lists=this.target.querySelectorAll(this.options.dragListClass);this.lists.forEach(b=>this.prepareList(b));this.cache=this.target.querySelector(".js-dragListValue");this.initDragula();const a=XF.Element.getHandler(f.querySelector("textarea[name=button_layout_preview_html]"),
"editor");a?(this.xfEditor=a,XF.on(a.target,"editor:init",this.rebuildValueCache.bind(this))):this.rebuildValueCache()},prepareList(a){if(a.matches(this.options.commandTrayClass))this.trayElements.push(a);else{this.listElements[this.listElements.length]=a;const b=this.getListId(a);this.getListOptions(b).forEach(c=>{XF.on(c,"change",()=>this.updateList(a,!0))})}this.updateList(a)},initDragula(){f.addEventListener("touchmove",b=>{this.isScrollable||b.preventDefault()},{passive:!1});const a=this.listElements;
for(let b in this.trayElements)a.unshift(this.trayElements[b]);this.dragula=dragula(a,{direction:"horizontal",removeOnSpill:!0,copy:(b,c)=>this.isTrayElement(c),accepts:(b,c)=>!this.isTrayElement(c),moves:(b,c,d,e)=>!b.classList.contains("toolbar-addDropdown")&&!b.classList.contains("fr-separator")});this.dragula.on("drag",this.drag.bind(this));this.dragula.on("dragend",this.dragend.bind(this));this.dragula.on("drop",this.drop.bind(this));this.dragula.on("cancel",this.cancel.bind(this));this.dragula.on("remove",
this.remove.bind(this));this.dragula.on("over",this.over.bind(this));this.dragula.on("out",this.out.bind(this))},drag(a,b){this.isScrollable=!1;a.classList.contains("toolbar-separator")&&!b.classList.contains("js-dragList-commandTray")&&(a=a.nextElementSibling)&&a.classList.contains("fr-separator")&&a.remove()},dragend(a){this.isScrollable=!0;let b;null==(b=f.querySelector(".js-dropTarget"))||b.remove()},drop(a,b,c,d){if(a.classList.contains("toolbar-separator"))this.appendSeparator(a);else{let e;
(null==(e=a.nextElementSibling)?0:e.matches(".fr-separator"))&&a.nextElementSibling.after(a)}"menu"===a.getAttribute("data-xf-click")&&a.removeAttribute("data-xf-click");this.isTrayElement(c)||this.updateList(c);this.isTrayElement(b)||this.updateList(b);this.rebuildValueCache()},cancel(a,b,c){a.classList.contains("toolbar-separator")&&!c.classList.contains("js-dragList-commandTray")&&this.appendSeparator(a)},remove(a,b,c){this.isTrayElement(c)||(XF.flashMessage(XF.phrase("button_removed"),1500),this.updateList(c,
!0))},over(a,b,c){},out(a,b,c){},getListId(a){return a.id.substr(12)},getListOptions(a){let b;return(null==(b=f.querySelector(`#js-toolbar-menu--${a}`))?void 0:b.querySelectorAll("input, select"))||[]},getListOptionValues(a){const b={buttons:[]};this.getListOptions(a).forEach(c=>{b[c.name]=c.value});return b},updateList(a,b){var c=this.getListId(a);c=this.getListOptionValues(c);Array.from(a.classList).filter(d=>d.match(/toolbar-option--[^\s$]+/g)).join(" ").split(" ").forEach(d=>{d.length&&a.classList.remove(d)});
a.classList.add("toolbar-option--buttonsVisible-"+c.buttonsVisible);a.classList.add("toolbar-option--align-"+c.align);b&&this.rebuildValueCache()},rebuildValueCache(a){const b={};this.cache&&(Array.from(this.lists).filter(c=>!c.classList.contains(this.options.commandTrayClass.slice(1))).forEach(c=>{const d=this.getListId(c),e=this.getListOptionValues(d);Array.from(c.children).forEach(g=>{g.dataset.cmd&&e.buttons.push(g.dataset.cmd)});b[d]=e}),this.cache.value=JSON.stringify(b),a&&"editor:init"===
a.type||this.updateEditorPreview(b))},updateEditorPreview(a){const b=this.xfEditor,c=f.querySelector(".js-editorToolbars");let d;b&&c&&(c.innerHTML=JSON.stringify({toolbarButtons:a}),b.ed.$tb.hasClass("fr-toolbar-open")?(d=b.ed.$tb.find(".fr-btn.fr-open").first().data("cmd"),b.reInit({afterInit(){b.ed.commands[d]()}})):b.reInit())},appendSeparator(a){const b=XF.createElementFromString(`<div class="fr-separator fr${a.dataset.cmd}"></div>`);a.after(b)},isTrayElement(a){return this.trayElements.includes(a)}});
XF.Element.register("editor-manager","XF.EditorManager")})(window,document);
