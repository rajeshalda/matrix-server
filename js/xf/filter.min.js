((q,n)=>{XF.Filter=XF.Element.newHandler({options:{inputEl:"| .js-filterInput",prefixEl:"| .js-filterPrefix",clearEl:"| .js-filterClear",countEl:".js-filterCount",totalsEl:".js-displayTotals",searchTarget:null,searchRow:null,searchRowGroup:null,searchLimit:"",key:"",ajax:null,noResultsFormat:'<div class="js-filterNoResults">%s</div>'},storageContainer:"filter",storageCutOff:3600,storageKey:null,input:null,prefix:null,clear:null,count:null,displayTotals:null,search:null,noResults:null,ajaxRows:null,
updateTimer:null,abortController:null,xhrFilter:null,init(){var a=this.target;this.options.searchTarget&&(this.search=XF.findRelativeIf(this.options.searchTarget,a));this.search||(this.search=a.nextElementSibling);this.search||(this.search=XF.findExtended("< .block | .dataList",a)[0]);this.search.matches(".dataList")&&!this.options.searchRow&&(this.options.searchRow=".dataList-row:not(.dataList-row--header):not(.dataList-row--subSection):not(.dataList-row--footer)",this.options.searchRowGroup=".dataList-rowGroup",
this.options.searchLimit=".dataList-cell:not(.dataList-cell--action):not(.dataList-cell--noSearch)",this.options.noResultsFormat='<tbody><tr class="js-filterNoResults dataList-row dataList-row--note dataList-row--noHover is-hidden"><td class="dataList-cell" colspan="50">%s</td></tr></tbody>');this.input=XF.findRelativeIf(this.options.inputEl,a);this.prefix=XF.findRelativeIf(this.options.prefixEl,a);this.clear=XF.findRelativeIf(this.options.clearEl,a);this.count=XF.findRelativeIf(this.options.countEl,
a.closest("form, .block"));this.displayTotals=XF.findRelativeIf(this.options.totalsEl,a.closest("form .block"));XF.on(this.input,"keyup",this.onKeyUp.bind(this));XF.on(this.input,"keypress",this.onKeyPress.bind(this));XF.on(this.input,"paste",this.onPaste.bind(this));XF.on(this.prefix,"change",this.onPrefixChange.bind(this));XF.on(this.clear,"click",this.onClearFilter.bind(this));this.storageKey=this.options.key;!this.storageKey.length&&(a=a.closest("form"))&&(this.storageKey=a.getAttribute("action"));
if(a=this._getStoredValue())this.input.value=a.filter,this.prefix.checked=a.prefix;this.input.value.length&&this.update();this._cleanUpStorage()},onKeyUp(a){if(!a.ctrlKey&&!a.metaKey){switch(a.key){case "Tab":case "Enter":case "Shift":case "Control":case "Alt":break;default:this.planUpdate()}"Enter"!=a.key&&this.planUpdate()}},onKeyPress(a){"Enter"==a.key&&(a.preventDefault(),this.update())},onPaste(a){this.planUpdate()},onPrefixChange(a){this.update()},onClearFilter(a){this.clear.matches(".is-disabled")||
(this.input.value="",this.prefix.checked=!1,this.update())},planUpdate(){this.updateTimer&&clearTimeout(this.updateTimer);this.updateTimer=setTimeout(this.update.bind(this),250)},update(){this.updateTimer&&clearTimeout(this.updateTimer);this.filter(this.input.value,this.prefix.checked?!0:!1)},_getSearchRows(a){a||(a=this.search);a=a.querySelectorAll(this.options.searchRow);this.noResults&&(a=Array.from(a).filter(b=>b!==this.noResults));return a},filter(a,b){this._updateStoredValue(a,b);this._toggleFilterHide(0<
a.length);this.options.ajax?this._filterAjax(a,b):(a=this._applyFilter(this._getSearchRows(),a,b),this._toggleNoResults(0==a))},_filterAjax(a,b){this.abortController&&(this.abortController.abort(),this.abortController=null);if(a.length){var c=Object.entries({text:a,prefix:b?1:0}).map(([d,e])=>`_xfFilter[${d}]=${encodeURIComponent(e)}`).join("&");c=this.options.ajax+"&"+c;this.xhrFilter={text:a,prefix:b};({abortController:a}=XF.ajaxAbortable("GET",c,this._filterAjaxResponse.bind(this)));a&&(this.abortController=
a)}else this._clearAjaxRows(),a=this._applyFilter(this._getSearchRows(),a,b),this._toggleNoResults(0==a)},_filterAjaxResponse(a){XF.setupHtmlInsert(a.html,(b,c,d)=>{this.abortController=null;this._clearAjaxRows();b=b.querySelectorAll(this.options.searchRow);c=this.xhrFilter;this._getSearchRows().forEach(e=>e.classList.add("is-hidden"));this._applyRowGroupLimit();this._toggleNoResults(0===b.length);b.length?(this._appendRows(b),XF.activateAll(b),this.ajaxRows=b,this._applyFilter(b,c.text,c.prefix)):
XF.layoutChange();this.xhrFilter=null;d(!0);return!1})},_applyFilter(a,b,c){const d=this.options.searchLimit;let e=0,f,k;b.length?(f=new RegExp((c?"^":"")+"("+XF.regexQuote(b)+")","i"),k=new RegExp((c?"^":"")+"("+XF.regexQuote(XF.htmlspecialchars(b))+")","ig")):k=f=!1;a.forEach(g=>{let l=!1;(d?g.querySelectorAll(d):[g]).forEach(p=>{p.querySelectorAll("span.is-match").forEach(h=>{const m=h.parentNode;for(;h.firstChild;)m.insertBefore(h.firstChild,h);m.removeChild(h);m.normalize()});!f||g.classList.contains("js-filterForceShow")?
l=!0:this._searchFilter(p,f,k)&&(l=!0)});l?(g.classList.remove("is-hidden"),g.classList.contains("js-filterForceShow")||e++):g.classList.add("is-hidden")});this._applyRowGroupLimit(0===b.length);this.updateDisplayTotals(e);XF.layoutChange();return e},_applyRowGroupLimit(a){const b=this.options.searchRowGroup,c=this.options.searchRow;b&&this.search.querySelectorAll(b).forEach(d=>{const e=Array.from(d.querySelectorAll(c)).filter(f=>!f.classList.contains("is-hidden"));a||e.length?d.classList.remove("is-hidden"):
d.classList.add("is-hidden")})},_searchFilter(a,b,c){let d=!1;if(a.nodeType===Node.TEXT_NODE)b.test(a.data)&&(d=!0,b=XF.createElementFromString("<span>"+XF.htmlspecialchars(a.data).replace(c,'<span class="is-match">$1</span>')+"</span>"),a.parentNode.replaceChild(b,a));else{a=Array.from(a.childNodes);for(let e=a.length-1;0<=e;e--)this._searchFilter(a[e],b,c)&&(d=!0)}return d},_clearAjaxRows(){this.ajaxRows&&(this.ajaxRows.forEach(a=>a.remove()),this.ajaxRows=null)},_toggleFilterHide(a){this.clear.classList.toggle("is-disabled",
!a);n.querySelectorAll(".js-filterHide").forEach(b=>{XF.display(b,a?"none":"")})},_toggleNoResults(a){a?(this.getNoResultsRow().classList.remove("is-hidden"),this.updateDisplayTotals(0)):this.noResults&&this.noResults.classList.add("is-hidden")},updateDisplayTotals(a){this.count&&(this.count.textContent=a);if(this.displayTotals){this.displayTotals.dataset.count=a;const b=this.displayTotals.dataset.total;this.displayTotals.textContent=XF.stringTranslate(1>a?XF.phrases.no_items_to_display:a===b?XF.phrases.showing_all_items:
XF.phrases.showing_x_of_y_items,{"{count}":a.toLocaleString(),"{total}":b.toLocaleString()})}},getNoResultsRow(){if(this.noResults)return this.noResults;var a=this.options.noResultsFormat.replace("%s",XF.phrase("no_items_matched_your_filter"));this.noResults=a=XF.createElementFromString("<table>"+a.trim()+"</table>").firstChild;this._appendRows([a]);a.matches(".js-filterNoResults")?this.noResults=a:this.noResults=a.querySelector(".js-filterNoResults");return this.noResults},_appendRows(a){var b=this.search.querySelectorAll(this.options.searchRow);
b=b.length?b[b.length-1]:null;let c=null;const d=this.options.searchRowGroup;b&&d&&(c=b.closest(d));!c&&b&&b.matches("tr")&&(c=b.closest("tbody"));!c&&b&&(c=b);c?Array.from(a).reverse().forEach(e=>{c.insertAdjacentElement("afterend",e)}):this.search.append(...a)},_getStoredValue(){if(!this.storageKey)return null;var a=this._readFromStorage();if(a[this.storageKey]){a=a[this.storageKey];const b=a.saved||0,c=Math.floor((new Date).getTime()/1E3);if(b+this.storageCutOff>=c)return{filter:a.filter||"",prefix:a.prefix||
!1}}return null},_updateStoredValue(a,b){if(this.storageKey){var c=this._readFromStorage();a.length?c[this.storageKey]={filter:a,prefix:b?!0:!1,saved:Math.floor((new Date).getTime()/1E3)}:c[this.storageKey]&&delete c[this.storageKey];this._writeToStorage(c)}},_cleanUpStorage(){if(this.storageKey){var a=this._readFromStorage(),b=!1,c=Math.floor((new Date).getTime()/1E3)-this.storageCutOff;for(const d of Object.keys(a))(a[d].saved||0)<c&&(delete a[d],b=!0);b&&this._writeToStorage(a)}},_readFromStorage(){return XF.LocalStorage.getJson(this.storageContainer)},
_writeToStorage(a){0===Object.keys(a).length?XF.LocalStorage.remove(this.storageContainer):XF.LocalStorage.setJson(this.storageContainer,a,!0)}});XF.PrefixGrabber=XF.Event.newHandler({eventNameSpace:"XFPrefixGrabberClick",options:{filterElement:"[data-xf-init~=filter]"},filterHandler:null,init(){this.filterHandler=XF.Element.getHandler(n.querySelector(this.options.filterElement),"filter");if(!(this.filterHandler instanceof XF.Filter))return console.warn("PrefixGrabber did not find an element with an XF.Filter handler"),
!1},click(a){if(this.filterHandler.prefix.checked){a=this.filterHandler.input.value;let b;a.length&&(b=this.target.getAttribute("href"),b=`${b}${-1===b.indexOf("?")?"?":"&"}prefix=${a}`,this.target.setAttribute("href",b))}}});XF.Element.register("filter","XF.Filter");XF.Event.register("click","prefix-grabber","XF.PrefixGrabber")})(window,document);
