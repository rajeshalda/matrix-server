((h,m)=>{XF.Nestable=XF.Element.newHandler({options:{rootClass:"nestable-container",listClass:"nestable-list",itemClass:"nestable-item",handleClass:"nestable-handle",dragClass:"nestable-dragel",collapsedClass:"nestable-collapsed",placeClass:"nestable-placeholder",noDragClass:"nestable-nodrag",emptyClass:"nestable-empty",classSuffix:"",maxDepth:1E4,groupId:null,parentId:null,valueInput:'| input[type="hidden"]',valueFunction:"asNestedSet"},valueInput:null,nestable:null,init(){if(this.options.classSuffix)for(var a in this.options)0<=
a.indexOf("Class")&&(this.options[a]+=this.options.classSuffix);this.valueInput=XF.findRelativeIf(this.options.valueInput,this.target);if(!this.valueInput)return console.error("No value input found matching selector %s",this.options.valueInput),!1;null===this.options.groupId&&(this.options.groupId=0);null===this.options.parentId&&(this.options.parentId=0);a={rootClass:this.options.rootClass,listClass:this.options.listClass,itemClass:this.options.itemClass,handleClass:this.options.handleClass,dragClass:this.options.dragClass,
collapsedClass:this.options.collapsedClass,placeClass:this.options.placeClass,noDragClass:this.options.noDragClass,emptyClass:this.options.emptyClass,expandBtnHTML:'<button type="button" class="nestable-button" data-action="expand">'+XF.Icon.getIcon("regular","plus-square")+"</button>",collapseBtnHTML:'<button type="button" class="nestable-button" data-action="collapse">'+XF.Icon.getIcon("regular","minus-square")+"</button>",maxDepth:this.options.maxDepth,group:this.options.groupId,parentID:this.options.parentId};
this.nestable=new XF.NestableList(this.target,a);XF.on(this.target,"change",this.change.bind(this));this.change()},change(a){this.valueInput.value=JSON.stringify(this.nestable[this.options.valueFunction]())}});XF.NestableList=XF.create({options:{listNodeName:"ol",itemNodeName:"li",parentID:0,rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',
collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20},target:null,placeEl:null,dragEl:null,dragRootEl:null,pointEl:null,dragDepth:0,hasNewRoot:!1,mouse:{},__construct(a,c){this.target=a;this.options=XF.extendObject({},this.options,c);this.init()},init(){this.reset();this.target.dataset.nestableGroup=this.options.group;this.placeEl=XF.createElementFromString(`<div class="${this.options.placeClass}"></div>`);const a=this.target.querySelectorAll(this.options.itemNodeName);
a.forEach(c=>{this.setParent(c)});a.length||this.appendEmptyElement(this.target);XF.onDelegated(this.target,"click","button",c=>{if(!this.dragEl){var b=c.target.closest("button");c=b.dataset.action;b=b.parentElement.closest(this.options.itemNodeName);"collapse"===c&&this.collapseItem(b);"expand"===c&&this.expandItem(b)}});this.hasTouchEvents()&&(XF.on(this.target,"touchstart",this.onStartEvent.bind(this)),XF.on(h,"touchmove",this.onMoveEvent.bind(this)),XF.on(h,"touchend",this.onEndEvent.bind(this)),
XF.on(h,"touchcancel",this.onEndEvent.bind(this)));XF.on(this.target,"mousedown",this.onStartEvent.bind(this));XF.on(h,"mousemove",this.onMoveEvent.bind(this));XF.on(h,"mouseup",this.onEndEvent.bind(this))},onStartEvent(a){if("touchstart"===a.type||1===a.which){const c="mousedown"!==a.type;let b=a.target;if(!b.classList.contains(this.options.handleClass)){if(b.closest(`.${this.options.noDragClass}`))return;b=b.closest(`.${this.options.handleClass}`)}!b||this.dragEl||!c&&0!==a.button||c&&1!==a.touches.length||
(a.preventDefault(),this.dragStart(c?a.touches[0]:a))}},onMoveEvent(a){const c="mousemove"!=a.type;this.dragEl&&(a.preventDefault(),this.dragMove(c?a.touches[0]:a))},onEndEvent(a){const c="mouseup"!=a.type;this.dragEl&&(a.preventDefault(),this.dragStop(c?a.touches[0]:a))},hasTouchEvents(){return XF.Feature.has("touchevents")},serialize(){const a=(c,b)=>{const e=[];Array.from(c.children).filter(d=>d.matches(this.options.itemNodeName)).forEach(d=>{const f={...d.dataset};d=Array.from(d.children).filter(g=>
g.matches(this.options.listNodeName));d.length&&(f.children=a(d,b+1));e.push(f)});return e};return a(this.target.querySelector(this.options.listNodeName),0)},asNestedSet(){let a=[],c=1;const b=(d,f,g)=>{let k=g+1;const q=this.options.listNodeName,r=this.options.itemNodeName;var l=d.querySelector(q);let n=[];l&&(n=Array.from(l.children).filter(p=>p.matches(`${r}`)));0<n.length&&(f++,n.forEach(p=>{k=b(p,f,k)}),f--);l=d.dataset.id;d=(d=d.closest(`${q}`).closest(`${r}`))?d.dataset.id:this.options.parentID;
l&&a.push({id:l,parent_id:d,depth:f,lft:g,rgt:k});return g=k+1},e=this.target.querySelector(this.options.listNodeName);e&&Array.from(e.children).forEach(d=>{d.nodeName.toLowerCase()===this.options.itemNodeName&&(c=b(d,0,c))});return a=a.sort((d,f)=>d.lft-f.lft)},reset(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0,moving:!1};this.dragRootEl=this.dragEl=null;this.dragDepth=0;this.hasNewRoot=
!1;this.pointEl=null},expandItem(a){a.classList.remove(this.options.collapsedClass);a.querySelectorAll('[data-action="expand"]').forEach(c=>XF.display(c,"none"));a.querySelectorAll('[data-action="collapse"]').forEach(c=>XF.display(c));a.querySelectorAll(this.options.listNodeName).forEach(c=>XF.display(c))},collapseItem(a){a.querySelectorAll(this.options.listNodeName).length&&(a.classList.add(this.options.collapsedClass),a.querySelectorAll('[data-action="collapse"]').forEach(c=>XF.display(c,"none")),
a.querySelectorAll('[data-action="expand"]').forEach(c=>XF.display(c)),a.querySelectorAll(this.options.listNodeName).forEach(c=>XF.display(c,"none")))},expandAll(){this.target.querySelectorAll(this.options.itemNodeName).forEach(a=>this.expandItem(a))},collapseAll(){this.target.querySelectorAll(this.options.itemNodeName).forEach(a=>this.collapseItem(a))},setParent(a){a.querySelectorAll(this.options.listNodeName).length&&(a.insertAdjacentHTML("afterbegin",this.options.expandBtnHTML),a.insertAdjacentHTML("afterbegin",
this.options.collapseBtnHTML));a.querySelectorAll('[data-action="expand"]').forEach(c=>XF.display(c,"none"))},unsetParent(a){a&&(a.classList.remove(this.options.collapsedClass),a.querySelectorAll("[data-action]").forEach(c=>c.remove()),a.querySelectorAll(this.options.listNodeName).forEach(c=>c.remove()))},dragStart(a){var c=a.target,b=c.closest(this.options.itemNodeName);this.placeEl.style.height=`${b.offsetHeight}px`;var e=void 0!==a.offsetX?a.offsetX:a.pageX-c.getBoundingClientRect().left;c=void 0!==
a.offsetY?a.offsetY:a.pageY-c.getBoundingClientRect().top;this.mouse={offsetX:e,offsetY:c,startX:a.pageX,lastX:a.pageX,startY:a.pageY,lastY:a.pageY};this.dragRootEl=this.target;e=b.offsetWidth;this.dragEl=XF.createElement(this.options.listNodeName,{className:`${this.options.listClass} ${this.options.dragClass}`,style:{width:`${e}px`},dataset:{dragWidth:e}});b.insertAdjacentElement("afterend",this.placeEl);b.parentNode.removeChild(b);this.dragEl.append(b);m.body.append(this.dragEl);b=a.pageX-this.mouse.offsetX;
a=a.pageY-this.mouse.offsetY;XF.isRtl()&&(b-=this.dragEl.dataset.dragWidth);this.dragEl.style.left=`${b}px`;this.dragEl.style.top=`${a}px`;a=this.dragEl.querySelectorAll(this.options.itemNodeName);this.dragDepth=Array.from(a).reduce((d,f)=>{f=Array.from(f.querySelectorAll(this.options.listNodeName)).length;return f>d?f:d},0)},dragStop(a){a=this.dragEl.querySelector(this.options.itemNodeName);a.parentNode.removeChild(a);this.placeEl.replaceWith(a);this.dragEl.remove();XF.trigger(this.target,"change");
this.hasNewRoot&&XF.trigger(this.dragRootEl,"change");this.reset()},dragMove(a){const c=this.options;var b=this.mouse;var e=a.pageX-b.offsetX;var d=a.pageY-b.offsetY;XF.isRtl()&&(e-=this.dragEl.dataset.dragWidth);this.dragEl.style.left=`${e}px`;this.dragEl.style.top=`${d}px`;b.lastX=b.nowX;b.lastY=b.nowY;b.nowX=a.pageX;b.nowY=a.pageY;b.distX=b.nowX-b.lastX;b.distY=b.nowY-b.lastY;b.lastDirX=b.dirX;b.lastDirY=b.dirY;b.dirX=0===b.distX?0:0<b.distX?1:-1;b.dirY=0===b.distY?0:0<b.distY?1:-1;e=Math.abs(b.distX)>
Math.abs(b.distY)?1:0;if(b.moving){b.dirAx!==e?(b.distAxX=0,b.distAxY=0):(b.distAxX+=Math.abs(b.distX),0!==b.dirX&&b.dirX!==b.lastDirX&&(b.distAxX=0),b.distAxY+=Math.abs(b.distY),0!==b.dirY&&b.dirY!==b.lastDirY&&(b.distAxY=0));b.dirAx=e;if(b.dirAx&&b.distAxX>=c.threshold){b.distAxX=0;d=this.placeEl.previousElementSibling;if((XF.isRtl()?0>b.distX:0<b.distX)&&d&&!d.classList.contains(c.collapsedClass)){e=Array.from(d.children).find(k=>k.tagName.toLowerCase()===c.listNodeName);var f=0;let g=this.placeEl.parentNode;
for(;g;)g instanceof Element&&g.tagName.toLowerCase()!==c.listNodeName||f++,g=g.parentNode;f+this.dragDepth<=c.maxDepth&&(e?(e=d.querySelectorAll(c.listNodeName+":last-child")[0],e.appendChild(this.placeEl)):(e=XF.createElement(c.listNodeName,{className:c.listClass},d),e.appendChild(this.placeEl),this.setParent(d)))}if(XF.isRtl()?0<b.distX:0>b.distX)e=this.placeEl.nextElementSibling,e&&e.tagName.toLowerCase()===c.itemNodeName||(e=this.placeEl.parentNode,(d=this.closest(this.placeEl,c.itemNodeName))&&
d.after(this.placeEl),e.hasChildNodes()||this.unsetParent(e.parentNode))}e=!1;(this.pointEl=m.elementFromPoint(a.pageX-m.body.scrollLeft,a.pageY-(h.scrollY||m.documentElement.scrollTop)))&&this.pointEl.classList.contains(c.handleClass)&&(this.pointEl=this.pointEl.closest(c.itemNodeName));if(this.pointEl&&this.pointEl.classList.contains(c.emptyClass))e=!0;else if(!this.pointEl||!this.pointEl.classList.contains(c.itemClass))return;d=this.pointEl.closest("."+c.rootClass);f=this.dragRootEl.dataset.nestableId!==
d.dataset.nestableId;b.dirAx&&!f&&!e||f&&c.group!==d.dataset.nestableGroup||(b=this.dragDepth-1+this.countParents(this.pointEl,c.listNodeName),b>c.maxDepth||(b=a.pageY<this.pointEl.offsetTop+this.pointEl.offsetHeight/2,a=this.placeEl.parentNode,e?(e=XF.createElement(c.listNodeName,{className:c.listClass}),e.appendChild(this.placeEl),this.pointEl.replaceWith(e)):b?this.pointEl.parentNode.insertBefore(this.placeEl,this.pointEl):this.pointEl.parentNode.insertBefore(this.placeEl,this.pointEl.nextElementSibling),
Array.from(a.children).length||this.unsetParent(a.parentNode),this.dragRootEl.querySelector(c.itemNodeName)||this.dragRootEl.querySelector("."+c.emptyClass)||this.appendEmptyElement(this.dragRootEl),this.dragRootEl=d,f&&(this.hasNewRoot=this.target!==this.dragRootEl)))}else b.dirAx=e,b.moving=!0},closest(a,c){for(;a;){if(a.matches(c))return a;a=a.parentElement}return null},countParents(a,c){let b=0;for(;a.parentNode;)a=a.parentNode,a.nodeName.toLowerCase()===c&&b++;return b},appendEmptyElement(a){a.append(XF.createElementFromString(`<div class="${this.options.emptyClass}"></div>`))}});
XF.Element.register("nestable","XF.Nestable")})(window,document);
